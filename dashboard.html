<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Employee Dashboard</title>

  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
</head>
<body>

<script>
  // Check login status
  const emp = JSON.parse(localStorage.getItem("employee"));
  if (!emp) {
    alert("Please login first");
    window.location.href = "index.html";
  }
</script>

<button onclick="logout()" style="position: absolute; top: 20px; right: 30px; padding: 8px 14px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Logout</button>

<div class="header" style="color: rgb(255, 255, 255); background-color: #82b5cc; padding: 20px; text-align: center;">
  <h2 id="welcome-msg">Welcome back</h2>
</div>

<div id="employee-documents"></div>
<div class="dashboard">
  <div class="profile-info" style="text-align: center;">
    <p><strong>Name:</strong> <span id="emp-name"></span></p>
    <p><strong>E-CODE:</strong> <span id="emp-id"></span></p>
    <p><strong>DOB:</strong> <span id="emp-dob"></span></p>
    <p><strong>Date of Joining:</strong> <span id="emp-joining"></span></p>
    <p><strong>Company Payroll Name:</strong> <span id="emp-payroll"></span></p>
    <p><strong>Designation:</strong> <span id="emp-designation"></span></p>
    <p><strong>Team:</strong> <span id="emp-team"></span></p>
    <p><strong>Grade:</strong> <span id="emp-grade"></span></p>
    <button id="policyBtn">View Company Policy</button>
    <button id="holidayListBtn" style="margin-top: 10px;">üìÖ View Holiday List</button>

  </div>

  <div class="right-panel">
    <div class="top-row">
      <div class="files-box">
        <h3>Documents</h3>
        <button id="offerBtn" style="margin-bottom: 10px;">View Offer Letter</button><br />
        <button id="salaryBtn">View Salary Slip</button>
      </div>

      <div class="leave-summary-box">
        <h3>Leave Summary</h3>
        <div class="leave-grid">
          <div class="leave-type pl">PL Left: <span id="pl-count">0</span></div>
          <div class="leave-type cl">CL Left: <span id="cl-count">0</span></div>
          <div class="leave-type sl">SL Left: <span id="sl-count">0</span></div>
          <div class="leave-type el">Early Leave Left: <span id="el-count">0</span></div>
        </div>
      </div>
    </div>

    <div class="event-list" id="eventListBox">
      <h3>Upcoming Events</h3>
      <div class="event-list"></div>
    </div>
  </div>

  <div class="calendar-box">
    <h3>Leave Calendar</h3>
    <div id="calendar"></div>
  </div>

  <div class="section">
    <h2>üìã Your Pending Documents</h2>
    <p id="pendingDocView">Loading...</p>
  </div>
</div>

<!-- Main Script -->
<!-- Main Script -->
<script>
  function formatDate(dateStr) {
    if (!dateStr) return "";
    const options = { day: "2-digit", month: "short", year: "numeric" };
    return new Date(dateStr).toLocaleDateString("en-IN", options);
  }

  document.addEventListener("DOMContentLoaded", async function () {
    try {
      // Fetch latest employee info
      const response = await fetch(`https://employee-login-backend-vlfa.onrender.com/api/employee/${emp.employee_id}`);
      if (!response.ok) throw new Error("Failed to fetch employee");

      const updatedEmp = await response.json();
      localStorage.setItem("employee", JSON.stringify(updatedEmp));

      // Show welcome and profile
      document.getElementById("welcome-msg").textContent = "Welcome back, " + updatedEmp.name;
      document.getElementById("emp-name").textContent = updatedEmp.name;
      document.getElementById("emp-id").textContent = updatedEmp.employee_id;
      document.getElementById("emp-dob").textContent = formatDate(updatedEmp.dob);
      document.getElementById("emp-joining").textContent = formatDate(updatedEmp.joining_date);
      document.getElementById("emp-payroll").textContent = updatedEmp.payroll_name;
      document.getElementById("emp-designation").textContent = updatedEmp.designation;
      document.getElementById("emp-team").textContent = updatedEmp.team;
      document.getElementById("emp-grade").textContent = updatedEmp.grade;


      // ‚úÖ Fetch leave summary from backend
      const sumRes = await fetch(`https://employee-login-backend-vlfa.onrender.com/api/leaves/summary/${updatedEmp.employee_id}`);
      if (!sumRes.ok) throw new Error("Failed to fetch leave summary");

      const summary = await sumRes.json();
      document.getElementById("pl-count").textContent = summary.pl ?? 0;
      document.getElementById("cl-count").textContent = summary.cl ?? 0;
      document.getElementById("sl-count").textContent = summary.sl ?? 0;
      document.getElementById("el-count").textContent = summary.el ?? 0;


 // ‚úÖ Fetch leave events from backend
      const evRes = await fetch(`https://employee-login-backend-vlfa.onrender.com/api/leave-events/${updatedEmp.employee_id}`);
      if (!evRes.ok) throw new Error("Failed to fetch leave events");

      const leaveEvents = await evRes.json();
      const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
        initialView: 'dayGridMonth',
        height: 'auto',
        events: leaveEvents
      });
      calendar.render();


      // Event list (fetch from DB)
      const listContainer = document.querySelector("#eventListBox .event-list");
      listContainer.innerHTML = "";
      
      try {
        const evRes = await fetch("https://employee-login-backend-vlfa.onrender.com/api/events");
        if (!evRes.ok) throw new Error("Failed to fetch events");
      
        const events = await evRes.json();
      
        if (events.length === 0) {
          listContainer.innerHTML = "<div>No upcoming events posted.</div>";
        } else {
          events.forEach(event => {
            const div = document.createElement("div");
            div.className = `event-item ${event.event_type}`;
      
            let label = "Event üè¢";
            if (event.event_type === "birthday") label = "Birthday üéÇ";
            else if (event.event_type === "anniversary") label = "Work Anniversary üéâ";
      
            div.innerHTML = `<strong>${event.title}</strong> ‚Äì ${label} ${formatDate(event.date)}`;
            listContainer.appendChild(div);
          });
        }
      } catch (err) {
        console.error("Events load error:", err);
        listContainer.innerHTML = "<div>Failed to load events.</div>";
      }


      // Pending documents
      const pending = localStorage.getItem("pendingDocs_" + updatedEmp.employee_id);
      document.getElementById("pendingDocView").textContent = pending || "No pending documents üéâ";

      // Document buttons
      document.getElementById("offerBtn").onclick = () => {
        const offer = employeeDocs.find(d => d.doc_type === "offerLetter");
        if (!offer) return alert("No Offer Letter uploaded.");
        const w = window.open();
        w.document.write(`<iframe src="${offer.file_path}" width="100%" height="100%"></iframe>`);
      };
      
      document.getElementById("salaryBtn").onclick = () => {
        const salary = employeeDocs.find(d => d.doc_type === "salarySlip");
        if (!salary) return alert("No Salary Slip uploaded.");
        const w = window.open();
        w.document.write(`<iframe src="${salary.file_path}" width="100%" height="100%"></iframe>`);
      };


      document.getElementById("policyBtn").onclick = () => {
        const w = window.open();
        w.document.write(`<iframe src="company-policy-2025.pdf" width="100%" height="100%"></iframe>`);
      };

      document.getElementById("holidayListBtn").onclick = () => {
        const w = window.open();
        w.document.write(`<iframe src="holiday-list-2025.pdf" width="100%" height="100%"></iframe>`);
      };

      // ‚úÖ Load employee documents after everything is ready
      await loadEmployeeDocuments();


    } catch (err) {
      console.error("Error:", err);
      alert("Failed to load dashboard");
      location.href = "index.html";
    }
  });

  function logout() {
    localStorage.removeItem("employee");
    location.replace("index.html");
  }
</script>
<script>
  // store docs globally after fetching
let employeeDocs = [];

async function loadEmployeeDocuments() {
  try {
    const API_BASE = "https://employee-login-backend-vlfa.onrender.com"; 
    const employee = JSON.parse(localStorage.getItem("employee")); 
    const employeeId = employee?.employee_id;

    if (!employeeId) {
      console.error("No employee ID found in localStorage.");
      return;
    }

    const docRes = await fetch(`${API_BASE}/api/documents/${employeeId}`);
    if (!docRes.ok) throw new Error("Failed to fetch documents");

    const docs = await docRes.json();
    employeeDocs = docs; // üëà save to global
    console.log("Employee documents:", docs);

    const docsContainer = document.getElementById("employee-documents");
    docsContainer.innerHTML = ""; 

    if (!docs.length) {
      docsContainer.innerHTML = "<p>No documents uploaded yet.</p>";
      return;
    }

    docs.forEach(doc => {
      const fileUrl = doc.file_path.startsWith("http")
        ? doc.file_path
        : `${API_BASE}/${doc.file_path}`;

      const div = document.createElement("div");
      div.innerHTML = `
        <p><strong>${doc.doc_type}</strong></p>
        <a href="${fileUrl}" target="_blank">View Document</a>
      `;
      docsContainer.appendChild(div);
    });

  } catch (err) {
    console.error("Error fetching documents:", err);
  }
}

</script> 

</body>
</html>









